<template>
  <div class="case-steps" v-loading="loading">
    
    <div class="steps-container">
      <draggable 
        v-model="steps" 
        item-key="step_id"
        handle=".drag-handle"
        ghost-class="ghost"
        @end="onDragEnd"
      >
        <template #item="{ element, index }">
          <div class="step-item">
            <el-collapse v-model="activeNames" @change="handleChange">
              <el-collapse-item :name="(element.step_id || (element as any).id || index).toString()">
                <template #title>
                  <div class="step-header">
                    <el-icon class="drag-handle"><Rank /></el-icon>
                    <span class="step-number">步骤{{ index + 1 }}</span>
                    <span class="step-title">{{ element.step_name }}</span>
                  </div>
                </template>
                <StepDetail 
                  :key="`step-${element.step_id || (element as any).id || index}`"
                  :step-id="element.step_id || (element as any).id" 
                  :step-name="element.step_name"
                  :stepParams="element"
                  @update:step-name="updateStepName(element.step_id || (element as any).id, $event)"
                  @step-saved="handleStepSaved"
                />
                <div class="step-actions">
                  <el-button size="small" type="danger" @click.stop="removeStep(element.step_id || (element as any).id)">删除步骤</el-button>
                </div>
              </el-collapse-item>
            </el-collapse>
          </div>
        </template>
      </draggable>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { ref, onMounted, defineExpose, watch, computed } from 'vue'
import StepDetail from './stepDetail.vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Rank, Upload } from '@element-plus/icons-vue'
import type { CollapseModelValue } from 'element-plus'
// 引入draggable组件
import draggable from 'vuedraggable'
// 引入Pinia store
import { useCaseGroupStore } from '@/store/caseGroupStore'

// 定义组件props
const props = defineProps<{
  caseId: number
}>()

// 使用Pinia store
const caseGroupStore = useCaseGroupStore()

// 从store获取步骤数据
const steps = computed({
  get: () => caseGroupStore.steps,
  set: (value) => {
    // 这里处理拖拽排序时的步骤更新
    if (caseGroupStore.caseGroupDetail) {
      caseGroupStore.caseGroupDetail.steps = value
    }
  }
})

// 当前激活的步骤
const activeNames = ref<string[]>([]);

// 加载状态直接从store获取
const loading = computed(() => caseGroupStore.loading)

// 组件挂载时不需要获取数据，因为父组件会通过store管理数据
onMounted(async () => {
  // 默认不展开任何步骤
  activeNames.value = [];
});

// 步骤拖拽结束事件处理
const onDragEnd = async () => {
  // 拖拽排序后，steps的computed setter会自动更新store中的数据
  // 这里只需要更新每个步骤的order并保存
  const updatedSteps = steps.value.map((step, index) => ({
    ...step,
    step_order: index + 1  // 从1开始编号
  }));
  
  // 触发每个步骤的更新以确保子组件同步
  for (const step of updatedSteps) {
    await caseGroupStore.updateStep(step.step_id || (step as any).id, step);
  }
  
  ElMessage.success('步骤顺序已更新');
};

// 添加新步骤
const addNewStep = async () => {
  console.log('🔥 addNewStep被调用，当前步骤数量:', steps.value.length);
  
  try {
    // 直接调用 Pinia store 的 addNewStep 方法
    await caseGroupStore.addNewStep();
    
    // 自动展开新添加的步骤（获取最后一个步骤）
    const newStep = caseGroupStore.steps[caseGroupStore.steps.length - 1];
    if (newStep) {
      activeNames.value = [newStep.step_id.toString()];
    }
    
    console.log('🎯 addNewStep完成，最终steps数组:', steps.value.map(s => ({ id: s.step_id, name: s.step_name })));
    ElMessage.success('已添加新步骤');
  } catch (error) {
    console.error('❌ 添加新步骤失败:', error);
    ElMessage.error('添加新步骤失败，请稍后重试');
  }
};

// 删除步骤
const removeStep = async (id: number) => {
  ElMessageBox.confirm(
    '确定要删除此步骤吗？此操作不可撤销。',
    '删除确认',
    {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning',
    }
  )
    .then(async () => {
      try {
        await caseGroupStore.removeStep(id);
        ElMessage.success('步骤已删除');
      } catch (error) {
        console.error('❌ 删除步骤失败:', error);
        ElMessage.error('删除步骤失败，请稍后重试');
      }
    })
    .catch(() => {
      ElMessage.info('已取消删除');
    });
};

// 更新步骤名称
const updateStepName = (stepId: number, newName: string) => {
  console.log(`📝 更新步骤名称: ID=${stepId}, 新名称="${newName}"`);
  
  // 由于使用了computed，直接修改store中的数据
  const step = caseGroupStore.steps.find(step => 
    step.step_id === stepId || (step as any).id === stepId
  );
  
  if (step) {
    step.step_name = newName;
    console.log('✅ 步骤名称更新成功');
  } else {
    console.warn(`⚠️ 未找到步骤 ID: ${stepId}`);
  }
};

// 处理步骤保存事件
const handleStepSaved = (stepId: number, stepData: any) => {
  console.log('🔄 handleStepSaved被调用:', { 
    stepId, 
    stepName: stepData.step_name,
    assertionsCount: stepData.assertions?.length || 0,
    currentStepsIds: steps.value.map(s => ({ id: s.step_id, name: s.step_name }))
  });
  
  // 首先尝试通过step_id查找步骤
  let stepIndex = steps.value.findIndex(step => step.step_id === stepId);
  console.log('📍 通过step_id查找结果:', stepIndex);
  
  // 如果找不到，再尝试通过id字段查找
  if (stepIndex === -1) {
    stepIndex = steps.value.findIndex(step => (step as any).id === stepId);
    console.log('📍 通过id字段查找结果:', stepIndex);
  }
  
  if (stepIndex !== -1) {
    console.log('✅ 找到步骤，更新索引:', stepIndex);
    // 合并数据，确保保留原始数据的结构
    const originalStep = steps.value[stepIndex];
    
    // 修复：确保stepData.step_name不为空，如果为空则保留原始步骤名称
    if (!stepData.step_name || stepData.step_name === '') {
      if (originalStep.step_name) {
        // 如果原步骤有名称，则保留原名称
        console.log(`⚠️ 发现stepData.step_name为空，保留原步骤名称: "${originalStep.step_name}"`);
        stepData.step_name = originalStep.step_name;
      } else {
        // 如果原步骤也没有名称，则设置默认名称
        stepData.step_name = `步骤${originalStep.step_order || stepIndex + 1}`;
        console.log(`⚠️ 发现步骤名称缺失，设置默认名称: "${stepData.step_name}"`);
      }
    }
    
    // 🔥 关键修复：智能保留assertions数据
    const originalAssertions = originalStep.assertions || [];
    const newAssertions = stepData.assertions || [];
    
    // 如果新数据的assertions为空，但原数据有assertions，则保留原数据
    const finalAssertions = newAssertions.length > 0 ? newAssertions : originalAssertions;
    
    console.log('assertions数据处理:', {
      original: originalAssertions.length,
      new: newAssertions.length,
      final: finalAssertions.length
    });
    
    const updatedStep = {
      ...originalStep,            // 保持原有数据
      ...stepData,                // 覆盖更新的数据
      step_id: stepId,           // 确保step_id不被修改
      step_order: originalStep.step_order, // 保留原始顺序
      assertions: finalAssertions // 🔥 使用智能合并的assertions
    };
    
    console.log('📝 步骤数据对比:', {
      before: { name: originalStep.step_name, assertions: originalStep.assertions?.length || 0 },
      after: { name: updatedStep.step_name, assertions: updatedStep.assertions?.length || 0 }
    });
    
    steps.value[stepIndex] = updatedStep;
  } else {
    // 如果找不到匹配的步骤，添加一个新步骤
    console.log(`找不到ID为${stepId}的步骤，添加新步骤`);
    stepData.step_id = stepId;
    stepData.step_order = steps.value.length + 1;
    steps.value.push(stepData);
  }
  
  // ❌ 移除对caseGroupData的同步更新，避免循环触发
  // 因为caseGroupData.steps会触发props.stepsData变化，导致循环
  // 让用例组保存时统一更新caseGroupData
  console.log('🎯 跳过caseGroupData同步，避免循环触发');
};

// 折叠面板变更事件 - 简化版，只负责展示面板
const handleChange = (val: CollapseModelValue) => {
  // 获取当前打开的步骤ID
  const currentStepId = Array.isArray(val) ? val[0] : val;

  // 如果没有步骤ID，或者步骤ID不是数字，不做任何操作
  if (!currentStepId || isNaN(Number(currentStepId))) {
    return;
  }
};

// 获取当前的步骤数据
const getStepsData = () => {
  // 直接从Pinia store返回步骤数据
  return caseGroupStore.steps;
};

// 保存步骤顺序的方法
const saveStepOrder = () => {
  // 确保步骤顺序是最新的
  steps.value.forEach((step, index) => {
    step.step_order = index + 1;
  });
  
  ElMessage.success('步骤顺序已保存');
  return true;
};

// 保存所有步骤数据的方法
const saveAllSteps = async () => {
  try {
    // 获取所有展开的步骤的引用
    const stepComponents = document.querySelectorAll('.step-item .el-collapse-item__wrap');
    let allValid = true;
    
    // 如果有展开的步骤，先调用其handleSave方法
    if (stepComponents && stepComponents.length > 0) {
      console.log(`找到 ${stepComponents.length} 个可能展开的步骤组件`);
      
      // 这里我们无法直接访问Vue组件实例，而是通过emit事件的方式来同步数据
      // 实际数据已经通过handleStepSaved方法更新到steps.value中
    }
    
    if (!allValid) {
      ElMessage.warning('部分步骤数据验证失败，请检查');
      return false;
    }
    
    // 返回所有步骤数据
    return getStepsData();
  } catch (error) {
    console.error('保存所有步骤时出错:', error);
    ElMessage.error('保存步骤数据失败');
    return false;
  }
};

// 公开方法给父组件调用
defineExpose({
  addNewStep,
  getStepsData,    // 添加获取步骤数据的方法
  saveStepOrder,   // 添加保存步骤顺序的方法
  saveAllSteps     // 添加保存所有步骤数据的方法
});
</script>

<style scoped lang="scss">
.case-steps {
  width: 100%;
  position: relative;
  min-height: 200px;
  
  .case-group-info {
    background-color: #f9fafc;
    border: 1px solid #ebeef5;
    border-radius: 4px;
    padding: 16px;
    margin-bottom: 20px;
    
    h2 {
      margin: 0 0 12px 0;
      font-size: 20px;
      color: #303133;
    }
    
    .info-row {
      margin: 6px 0;
      display: flex;
      align-items: center;
      
      .label {
        color: #606266;
        margin-right: 8px;
        font-weight: 500;
      }
      
      .value {
        color: #303133;
      }
    }
  }
  
  .steps-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    
    h2 {
      margin: 0;
      font-size: 18px;
      color: #303133;
    }
    
    .actions {
      display: flex;
      gap: 8px;
    }
  }
  
  .steps-container {
    border: 1px solid #ebeef5;
    border-radius: 4px;
    
    .step-item {
      border-bottom: 1px solid #ebeef5;
      
      &:last-child {
        border-bottom: none;
      }
      
      .step-header {
        display: flex;
        align-items: center;
        gap: 12px;
        
        .drag-handle {
          cursor: move;
          color: #909399;
          
          &:hover {
            color: #409eff;
          }
        }
        
        .step-number {
          font-weight: bold;
          color: #606266;
        }
        
        .step-title {
          color: #303133;
        }
      }
    }
  }
}

/* 拖拽时的样式 */
.ghost {
  opacity: 0.5;
  background: #c8ebfb;
}

/* 确保el-collapse不影响拖拽功能 */
:deep(.el-collapse) {
  border: none;
}

:deep(.el-collapse-item) {
  border-bottom: none;
}

/* 步骤操作按钮区域 */
.step-actions {
  display: flex;
  justify-content: flex-end;
  padding: 12px 0;
  margin-top: 12px;
  border-top: 1px dashed #ebeef5;
}
</style>
