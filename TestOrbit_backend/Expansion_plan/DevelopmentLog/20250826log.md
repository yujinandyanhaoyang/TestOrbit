
# 开发日志 - 2025年8月26日

## 📋 项目概述
完成定时任务系统的核心功能开发，包括任务创建、查询、更新、取消和自动调度执行。

## 🎯 主要功能实现

### 1. 定时任务数据模型设计
- **ScheduledTask 模型**：继承 ComTimeModel 和 UserEditModel
- **核心字段**：
  - `task_name`: 任务名称
  - `case_ids`: JSON字段存储测试用例ID列表
  - `parallel`: 执行模式（0=串行，1=并行）
  - `owner_ids`: JSON字段存储负责人ID列表
  - `scheduled_time`: 预定执行时间
  - `status`: 任务状态（pending, running, completed, failed, cancelled）
  - `execution_mode`: 执行模式字符串
  - `execution_count`: 执行次数计数

### 2. API 接口开发

#### 2.1 创建/更新定时任务接口
- **路径**: `POST /api-data/schedule-api-cases`
- **功能**: 
  - 创建任务（不包含task_id）
  - 更新任务（包含task_id，完全更新模式）
- **请求格式**:
  ```json
  // 创建任务
  {
      "case_ids": [22, 20],
      "parallel": 1,
      "owner_ids": [1, 2],
      "startTime": "2025-08-26T15:00:00"
  }
  
  // 更新任务（必须包含所有字段）
  {
      "task_id": 1,
      "case_ids": [25, 30],
      "parallel": 0,
      "owner_ids": [1, 3],
      "startTime": "2025-08-26T16:30:00"
  }
  ```

#### 2.2 获取定时任务列表接口
- **路径**: `GET /api-data/scheduled-tasks`
- **功能**: 获取用户相关的定时任务列表
- **查询参数**: `status` - 任务状态过滤
- **返回数据**: 包含任务详情、关联用例信息、负责人信息

#### 2.3 取消定时任务接口
- **路径**: `POST /api-data/cancel-scheduled-task`
- **功能**: 取消pending状态的定时任务
- **请求格式**:
  ```json
  {
      "task_id": 1
  }
  ```

### 3. 定时调度器系统

#### 3.1 TaskScheduler 单例类
- **文件**: `apiData/views/function/scheduled_tasks.py`
- **功能**: 
  - 后台线程持续监控数据库
  - 检查待执行任务（status='pending', scheduled_time<=当前时间）
  - 自动执行到期任务
  - 详细的日志记录

#### 3.2 自动启动机制
- **文件**: `apiData/apps.py`
- **实现**: 在Django应用启动时自动启动调度器
- **安全机制**: 使用RUN_MAIN环境变量避免重复启动

### 4. 时间格式标准化
- **格式**: 统一使用ISO 8601格式 `YYYY-MM-DDTHH:MM:SS`
- **时区处理**: 项目使用naive datetime (USE_TZ=False)
- **验证**: 确保预定时间必须是未来时间

### 5. 权限认证系统优化

#### 5.1 认证问题排查
- **问题**: Token认证失效，`request.user.id` 返回None
- **原因**: URL路径不匹配导致自定义认证类跳过认证
- **解决**: 修正settings.py中AUTHORIZE_API配置
  ```python
  AUTHORIZE_API = (
      '/user/user-cfg-params',
      '/api-data/scheduled-tasks',      # 修正路径
      '/api-data/schedule-api-cases',   # 修正路径
      '/api-data/cancel-scheduled-task', # 修正路径
  )
  ```

#### 5.2 Token管理优化
- **文件**: `user/views.py`
- **改进**: 登录时删除旧Token，生成新Token提高安全性

### 6. 调试工具开发
- **监控脚本**: `monitor_tasks.py` - 实时监控任务状态
- **手动测试**: `manual_scheduler_test.py` - 手动测试调度器
- **Token获取**: `get_user_tokens.py` - 获取用户认证Token

## 🔧 技术实现细节

### 数据库查询优化
- 使用JSON字段 `__contains` 查询用户权限
- `select_related` 优化关联查询
- 精确的时间比较查询

### 错误处理机制
- **参数验证**: 完整的输入参数验证
- **权限控制**: 用户只能操作自己负责的任务
- **状态检查**: 严格的任务状态转换控制
- **异常处理**: 详细的错误信息返回

### 调度器设计
- **单例模式**: 确保全局唯一调度器实例
- **线程安全**: 使用daemon线程避免阻塞主进程
- **容错机制**: 异常捕获和日志记录
- **性能优化**: 可配置的检查间隔（当前1分钟，生产环境5分钟）

## 🧪 测试验证

### Postman接口测试
- **认证配置**: `Authorization: Token <token_value>`
- **创建任务**: 验证参数完整性和时间格式
- **更新任务**: 完全更新模式，缺少字段返回"缺少必要参数"
- **查询列表**: 支持状态过滤
- **取消任务**: 只能取消pending状态任务

### 调度器测试
- **实时监控**: 确认任务到期自动执行
- **状态更新**: 验证任务状态正确转换
- **日志输出**: 详细的执行过程记录

## 📊 当前状态
- ✅ **定时任务CRUD完成**
- ✅ **定时扫描器正常运行**
- ✅ **权限认证系统修复**
- ✅ **接口功能验证通过**
- ✅ **数据库操作优化**

## 🔄 下一步计划
1. **性能优化**: 调整调度器检查间隔为5分钟
2. **监控增强**: 添加任务执行结果通知
3. **容错改进**: 增加失败重试机制
4. **文档完善**: 补充API接口文档和使用说明

## 🔄 接口功能扩展

### 接口优化工作
1. **创建/更新接口合并**: 通过检查请求体中是否包含 `task_id` 来区分创建和更新操作
2. **完全更新模式**: 更新操作要求提供所有必要字段，缺少字段统一返回"缺少必要参数"
3. **参数验证增强**: 
   - 严格的字段类型检查
   - 数据库关联验证（case_ids, owner_ids）
   - 时间格式和未来时间验证
   - 任务状态权限控制（只能修改pending状态任务）

### Postman 接口测试
1. **Token认证问题排查与解决**：
   - **问题现象**: `request.user.id` 返回 None
   - **根本原因**: URL路径不匹配导致自定义认证类跳过认证
     - 实际请求路径: `/api-data/scheduled-tasks`
     - settings.py配置: `/apiData/scheduled-tasks`
   - **解决方案**: 修正 AUTHORIZE_API 配置中的路径

2. **Token管理优化**：
   - 修改登录逻辑，每次登录删除旧Token并生成新Token
   - 提高安全性，防止多设备同时使用同一Token

3. **接口测试验证**：
   - ✅ 创建定时任务测试通过
   - ✅ 获取任务列表（支持状态过滤）测试通过
   - ✅ 更新定时任务（完全更新模式）测试通过
   - ✅ 取消定时任务测试通过

## ⚠️ 遇到的技术难题

### 用户模型重构问题
1. **问题背景**: 
   - 项目中存在命名不一致问题：
     - settings.py: `AUTH_USER_MODEL = 'user.LimUser'`
     - 实际模型类名: `ExpendUser`
     - 代码引用: 混用 `LimUser` 和 `ExpendUser`

2. **重构尝试**:
   - 尝试将模型统一重命名为 `ExpendUser`（PascalCase）
   - 更新所有相关文件的引用
   - 生成数据库迁移文件

3. **遇到的迁移问题**:
   ```
   ValueError: The field admin.LogEntry.user was declared with a lazy reference to 'user.ExpendUser', 
   but app 'user' doesn't provide model 'ExpendUser'.
   ```
   - **问题分析**: Django迁移系统中存在大小写敏感的引用问题
   - **影响范围**: admin.LogEntry, apiData.ApiCase, apiData.ScheduledTask, authtoken.Token 等多个模型
   - **当前状态**: 暂时回滚，保持原有 `LimUser` 命名

4. **后续计划**:
   - 需要仔细分析所有迁移文件中的用户模型引用
   - 可能需要手动创建数据转换迁移
   - 或者保持现有命名，在代码层面统一引用

## 🛠️ 调试工具完善

### 开发的调试辅助脚本
1. **monitor_tasks.py**: 实时监控定时任务状态变化
2. **manual_scheduler_test.py**: 手动测试调度器功能
3. **get_user_tokens.py**: 获取用户认证Token（已删除）
4. **详细日志输出**: 在接口中添加Token验证和用户认证状态的详细日志

## 📊 当前状态
- ✅ **定时任务CRUD完成**
- ✅ **定时扫描器正常运行**
- ✅ **权限认证系统修复**
- ✅ **接口功能验证通过**
- ✅ **数据库操作优化**
- ⚠️ **用户模型重构待解决**

## 🔄 下一步计划
1、用例模块关联项目组，有项目组权限者可对项目进行所有操作。用例模块对无权限者只读。
3、用例模块在项目组下创建。创建用例模块自动关联项目组。
4、用例模块、用例组、用例步骤对于无项目权限者保持只读
2、新建项目环境关系表。一个项目可以对应多个环境。每个环境只能对应一个项目。

5、用例报告统计用例组执行时，所有步骤成功数/失败数。每个步骤执行状态成功or失败，各个步骤执行结果。
6、定时任务向负责人发送该任务中各个用例组的通过率列表。

## � 用户管理功能增强

### 1. 用户创建功能
- **路径**: `POST /user/user-view`
- **功能**: 创建新用户，支持默认密码
- **实现细节**:
  - 使用Django内置的`make_password`方法安全加密用户密码
  - 支持默认密码设置（未提供密码时默认为'123456'）
  - 集成用户信息验证与错误处理

### 2. 用户-项目组关系模型设计
- **模型**: 添加`UserProjectRelation`中间表模型
- **字段**:
  - `user`: 外键关联到ExpendUser
  - `project`: 外键关联到Project
- **关联方式**: 使用`through`参数自定义多对多关系
- **约束**: 通过`unique_together`确保用户-项目关系唯一性
- **删除行为**: 
  - 用户删除不影响项目
  - 项目删除时自动从用户的项目关联中移除

### 3. 项目分配功能
- **路径**: `POST /user/assign-projects`
- **功能**: 超级管理员为用户分配项目组
- **权限控制**: 仅限超级管理员使用
- **请求格式**:
  ```json
  {
    "user_id": 5,
    "project_ids": [1, 2]
  }
  ```
- **返回格式**:
  ```json
  {
    "msg": "成功为用户 testuser 分配项目",
    "user_id": 5,
    "username": "testuser",
    "current_projects": [
      {"id": 1, "name": "项目A"},
      {"id": 2, "name": "项目B"}
    ],
    "project_count": 2
  }
  ```

### 4. 用户登录增强
- **功能**: 更新用户最后登录时间
- **实现**: 
  - 在用户成功认证后，记录`last_login`时间
  - 使用Django的`timezone`模块获取当前时间
  - 使用`update_fields`优化数据库操作

### 5. 技术挑战与解决
- **多对多关系迁移问题**: 
  - 问题: 直接修改多对多字段类型导致迁移错误
  - 解决: 分步迁移（先移除字段，再添加新字段）
- **认证问题排查**:
  - 添加Token信息打印和调试代码
  - 确认请求方法必须为POST而非GET

## �📝 技术备注
- **项目框架**: Django 5.2.3 + Django REST Framework
- **数据库**: MySQL，支持JSON字段查询和多对多关系
- **时间标准**: ISO 8601格式，naive datetime
- **认证方式**: Token认证，支持多设备登录控制
- **当前难题**: 用户模型重命名和数据库迁移冲突

## 💡 经验总结
1. **Django用户模型扩展**: 使用 `AUTH_USER_MODEL` 时需要保持命名一致性
2. **数据库迁移**: 涉及用户模型的修改需要特别小心，影响面广
3. **Token认证调试**: URL路径配置是认证失效的常见原因
4. **JSON字段查询**: 使用 `__contains` 进行数组包含查询
5. **定时任务设计**: 单例模式+后台线程是可靠的调度方案
6. **多对多关系自定义**: 使用`through`参数自定义中间表提供更精细的控制
7. **分步骤迁移**: 复杂字段类型更改需要分步骤执行迁移

---
*最后更新时间：2025-08-26 晚上*
*状态：定时任务功能完成，用户管理功能增强完成，用户模型重构待解决*