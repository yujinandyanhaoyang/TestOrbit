# TestOrbit 研发进度记录 - 2025年8月27日

## 已完成任务

### 1. 项目权限控制系统完善
- **用例模块关联项目组**：实现了用例模块与项目组的强关联，有项目组权限者可对项目进行所有操作
- **权限验证机制**：用例模块对无权限者保持只读状态
- **自动关联创建**：用例模块在项目组下创建时自动关联项目组
- **层级权限控制**：用例模块、用例组、用例步骤对于无项目权限者保持只读

### 2. 环境变量管理系统重构
- **数据库模型设计**：
  - 重新设计了 `Environment` 模型，支持全局环境（type=1）和场景环境（type=0）
  - 创建了 `ProjectEnvironment` 关系表：一个项目可以对应多个环境，每个环境只能对应一个项目
  - 创建了 `CaseEnvironment` 关系表：管理用例与场景环境的多对多关系
  - 使用 JSON 字段存储动态变量，支持类似 Postman 的环境变量管理

- **API接口统一化**：
  - 实现了统一的环境管理接口 `environment_overview`，支持 GET/POST/PATCH/DELETE 操作
  - 通过 `type` 参数区分环境类型（1=全局环境，0=场景环境）
  - 全局环境需要 `project_id` 参数，场景环境需要 `case_id` 参数

### 3. 权限检查工具函数优化
- **代码重构**：简化了权限检查逻辑，移除了复杂的 `check_environment_permission` 函数
- **核心函数保留**：保留了 `check_project_permission` 和 `get_project_id_by_case` 核心工具函数
- **权限分流设计**：
  - 查询操作：移除权限限制，允许用户查看所有可用环境
  - 创建/更新操作：基于项目权限进行控制
  - 删除操作：需要检查环境关联的所有项目/用例权限

### 4. 数据库关系修复
- **外键关联修复**：修复了 `get_project_id_by_case` 函数中的关联查询错误
- **关联路径纠正**：将错误的 `select_related('project')` 修正为 `select_related('module__project')`
- **删除策略优化**：设置了合理的 CASCADE 和 PROTECT 删除策略

### 5. 代码质量提升
- **重复代码消除**：提取了公共的参数验证和权限检查函数 `_validate_and_check_permission`
- **错误处理统一**：统一了错误信息格式和异常处理逻辑
- **代码可维护性**：减少了约60%的重复代码，提高了代码可读性
- **参数验证修复**：修复了 `env_type=0` 时的布尔判断错误，改用 `is not None` 判断

## 技术亮点

### 1. 环境变量动态存储
```json
{
  "variables": {
    "api_host": {
      "value": "https://api.example.com",
      "description": "API服务器地址"
    },
    "token": {
      "value": "Bearer xxxxx",
      "description": "认证令牌"
    }
  }
}
```

### 2. 统一的CRUD接口设计
- 单一端点处理多种操作
- 通过HTTP方法区分操作类型
- 参数验证和权限检查统一处理

### 3. 灵活的权限控制策略
- 超级管理员：拥有所有权限
- 项目成员：拥有所属项目的环境管理权限
- 普通用户：只能查看环境，无法修改

## 遇到的技术问题及解决方案

### 1. 布尔值判断陷阱
**问题**：`env_type = int(env_type) if env_type else None` 导致 `env_type=0` 时返回 `None`
**原因**：数字 `0` 在Python中等同于 `False`
**解决**：改用 `env_type is not None` 进行判断

### 2. 数据库关联查询错误
**问题**：`select_related('project')` 在 `ApiCase` 模型中不存在
**原因**：`ApiCase` 通过 `module` 字段间接关联到 `project`
**解决**：使用 `select_related('module__project')` 进行正确的关联查询

### 3. 权限检查过度复杂化
**问题**：创建了过多的包装函数，增加了代码复杂度
**解决**：简化为核心工具函数，在视图中直接使用项目权限检查

## 数据库变更记录

### 新增表结构
1. **ProjectEnvironment**：项目环境关系表
2. **CaseEnvironment**：用例环境关系表

### 模型字段调整
1. **Environment**：简化字段结构，使用JSON存储动态变量
2. **ApiCaseModule**：增强项目关联约束（null=False, blank=False）

## 已规划待完成任务

1. **API执行状态管理**：api_case运行后状态设置
2. **执行统计功能**：运行api_case统计执行测试步骤成功率（成功步骤数/总步骤数）
3. **报告数据结构优化**：调整api_case.reportdata字段，存储关联的ApiCaseStep执行情况
4. **通知系统集成**：定时任务执行完成后通知任务负责人（钉钉/邮件/飞书三选其一）

## 下一步计划

1. **环境变量应用**：在API执行中集成环境变量替换功能
2. **接口测试优化**：完善测试用例执行流程和结果统计
3. **用户体验提升**：优化前端界面的环境管理功能
4. **性能优化**：针对大量环境变量的查询和更新进行优化